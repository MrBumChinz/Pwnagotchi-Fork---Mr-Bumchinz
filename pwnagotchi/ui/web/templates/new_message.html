{% extends "base.html" %}
{% set active_page = "new" %}

{% block title %}
{% if to %}
Reply to {{ to[:16] }}... | Pwnagotchi
{% else %}
New Message | Pwnagotchi
{% endif %}
{% endblock %}

{% block script %}
$(function(){
    $("#message_form").submit(function(e) {
        e.preventDefault();
        
        var form = $(this);
        var url = form.attr('action');
        var submitBtn = form.find('input[type=submit]');
        
        submitBtn.val('ğŸ“¤ Sending...');
        submitBtn.prop('disabled', true);

        $.ajax({
            type: "POST",
            url: url,
            data: form.serialize(),
            success: function(data) {
                if (data.error) {
                    submitBtn.val('âœ‰ï¸ Send Message');
                    submitBtn.prop('disabled', false);
                    
                    if (data.error.indexOf('404') != -1)
                        alert('âŒ Fingerprint not found.');
                    else if (data.error.indexOf('aborted') != -1)
                        alert('âŒ Empty or invalid message.');
                    else
                        alert('âŒ ' + data.error);
                    return;
                }

                submitBtn.val('âœ… Sent!');
                setTimeout(function() {
                    document.location.href = "/inbox";
                }, 1000);
            },
            error: function() {
                submitBtn.val('âœ‰ï¸ Send Message');
                submitBtn.prop('disabled', false);
                alert('âŒ Network error. Please try again.');
            }
        });
    });
});
{% endblock %}

{% block content %}
<div class="page-header">
    <h1>âœ‰ï¸ {% if to %}Reply{% else %}New Message{% endif %}</h1>
    <p>Send a message to another Pwnagotchi</p>
</div>

<div style="padding: 20px;">
    <div class="card">
        <form id="message_form" method="POST" action="/inbox/send">
            <div style="margin-bottom: 20px;">
                <label for="to">ğŸ”‘ Recipient Fingerprint</label>
                <input type="text" name="to" id="to" value="{{ to }}" 
                       placeholder="Enter the recipient's fingerprint..." 
                       style="font-family: monospace;">
            </div>
            
            <div style="margin-bottom: 20px;">
                <label for="message">ğŸ“ Message</label>
                <textarea cols="40" rows="8" name="message" id="message" 
                          placeholder="Type your message here..."
                          style="resize: vertical; min-height: 150px;"></textarea>
            </div>
            
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
            <input type="submit" class="button" value="âœ‰ï¸ Send Message" style="width: 100%;">
        </form>
    </div>
    
    <div class="card" style="margin-top: 20px;">
        <h4 style="color: var(--accent-color); margin-bottom: 15px;">ğŸ’¡ Tips</h4>
        <ul style="color: var(--text-secondary); padding-left: 20px;">
            <li>You can find fingerprints in the Peers section</li>
            <li>Messages are encrypted end-to-end</li>
            <li>Messages are delivered via PwnGrid mesh network</li>
        </ul>
    </div>
</div>
{% endblock %}
